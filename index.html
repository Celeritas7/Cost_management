<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cost Management Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-is@18/umd/react-is.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prop-types@15/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.15.3/umd/Recharts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.9/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    html, body, #root { margin: 0; padding: 0; min-height: 100vh; }
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Noto Sans JP', system-ui, sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    input:focus, select:focus { outline: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // âš™ï¸  SUPABASE CONFIG â€” Replace with your keys
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SUPABASE_URL  = "https://wylxvmkcrexwfpjpbhyy.supabase.co";   // e.g. https://xyzxyz.supabase.co
    const SUPABASE_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak";

    const supabaseConfigured = SUPABASE_URL !== "YOUR_SUPABASE_URL" && SUPABASE_KEY !== "YOUR_SUPABASE_ANON_KEY";
    const supabase = supabaseConfigured ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const { useState, useMemo, useEffect, useCallback, useRef } = React;
    const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, AreaChart, Area, CartesianGrid } = Recharts;

    const MONTHS_SHORT = ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const MONTHS_FULL = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const CATEGORIES = ["Supermarket","Convenience","Asian shop","Restaurant","Other","Daily need stuffs"];
    const CAT_COLORS = {
      "Supermarket":"#2563eb","Convenience":"#f59e0b","Asian shop":"#10b981",
      "Restaurant":"#ef4444","Other":"#8b5cf6","Daily need stuffs":"#ec4899",
    };
    const CAT_ICONS = {
      "Supermarket":"ğŸ›’","Convenience":"ğŸª","Asian shop":"ğŸŒ",
      "Restaurant":"ğŸœ","Other":"ğŸ“¦","Daily need stuffs":"ğŸ§¹",
    };
    const fmt = (n) => `Â¥${n.toLocaleString()}`;

    function enrichRow(r) {
      const d = new Date(r.date);
      return { ...r, year: d.getFullYear(), month: d.getMonth() + 1, monthLabel: `${MONTHS_SHORT[d.getMonth()+1]} ${d.getFullYear()}` };
    }

    const CustomTooltip = ({ active, payload, label }) => {
      if (!active || !payload?.length) return null;
      return (
        <div style={{background:"#1a1a2e",border:"1px solid #333",borderRadius:8,padding:"10px 14px",color:"#e0e0e0",fontSize:13}}>
          <div style={{fontWeight:600,marginBottom:4,color:"#fff"}}>{label}</div>
          {payload.map((p,i) => <div key={i} style={{color:p.color||"#ccc"}}>{p.name}: {fmt(p.value)}</div>)}
        </div>
      );
    };

    const pillStyle = (active) => ({
      padding:"7px 16px",fontSize:13,borderRadius:20,border:"none",cursor:"pointer",fontWeight:500,
      background: active ? "rgba(37,99,235,0.9)" : "rgba(255,255,255,0.06)",
      color: active ? "#fff" : "#aaa",transition:"all 0.2s",
    });

    const inputStyle = {
      width:"100%",padding:"10px 14px",borderRadius:10,border:"1px solid rgba(255,255,255,0.12)",
      background:"rgba(255,255,255,0.06)",color:"#eee",fontSize:14,outline:"none",
      fontFamily:"inherit",transition:"border-color 0.2s",
    };

    const labelStyle = { fontSize:12,fontWeight:500,color:"#999",textTransform:"uppercase",letterSpacing:0.8,marginBottom:6,display:"block" };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MAIN APP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function App() {
      const [data, setData] = useState([]);
      const [shops, setShops] = useState([]);
      const [loading, setLoading] = useState(true);
      const [yearFilter, setYearFilter] = useState("All");
      const [catFilter, setCatFilter] = useState("All");
      const [view, setView] = useState("add"); // Default to Add Entry
      const [txPage, setTxPage] = useState(0);

      const fetchData = useCallback(async () => {
        if (!supabase) { setLoading(false); return; }
        setLoading(true);
        const [expRes, shopRes] = await Promise.all([
          supabase.from("cost_management_expenses").select("*").order("date", { ascending: true }),
          supabase.from("cost_management_shops").select("*").order("is_favorite", { ascending: false }).order("name"),
        ]);
        if (!expRes.error && expRes.data) {
          setData(expRes.data.map(r => enrichRow({ id: r.id, amount: r.amount, date: r.date, category: r.category, shop: r.shop, notes: r.notes || "" })));
          const years = [...new Set(expRes.data.map(r => new Date(r.date).getFullYear()))];
          if (years.length) setYearFilter(String(Math.max(...years)));
        }
        if (!shopRes.error && shopRes.data) setShops(shopRes.data);
        setLoading(false);
      }, []);

      useEffect(() => { fetchData(); }, [fetchData]);

      const RAW = data;
      const categories = useMemo(() => [...new Set(RAW.map(r => r.category))].sort(), [RAW]);
      const years = useMemo(() => [...new Set(RAW.map(r => String(r.year)))].sort(), [RAW]);

      const filtered = useMemo(() => RAW.filter(r => {
        if (yearFilter !== "All" && String(r.year) !== yearFilter) return false;
        if (catFilter !== "All" && r.category !== catFilter) return false;
        return true;
      }), [RAW, yearFilter, catFilter]);

      const totalSpend = useMemo(() => filtered.reduce((s,r) => s+r.amount, 0), [filtered]);
      const txCount = filtered.length;

      const monthlyData = useMemo(() => {
        const map = {};
        filtered.forEach(r => {
          const key = `${r.year}-${String(r.month).padStart(2,"0")}`;
          const label = `${MONTHS_SHORT[r.month]} ${String(r.year).slice(2)}`;
          if (!map[key]) map[key] = { key, label, total: 0 };
          map[key].total += r.amount;
        });
        return Object.values(map).sort((a,b) => a.key.localeCompare(b.key));
      }, [filtered]);

      const monthlyAvg = useMemo(() => monthlyData.length ? Math.round(totalSpend / monthlyData.length) : 0, [totalSpend, monthlyData]);
      const dailyAvg = useMemo(() => {
        if (!filtered.length) return 0;
        return Math.round(totalSpend / new Set(filtered.map(r => r.date)).size);
      }, [filtered, totalSpend]);

      const catData = useMemo(() => {
        const map = {};
        filtered.forEach(r => { map[r.category] = (map[r.category]||0) + r.amount; });
        return Object.entries(map).map(([name,value]) => ({name,value})).sort((a,b) => b.value-a.value);
      }, [filtered]);

      const topShops = useMemo(() => {
        const map = {};
        filtered.forEach(r => {
          const name = r.shop === "Other" && r.notes ? r.notes : r.shop;
          map[name] = (map[name]||0) + r.amount;
        });
        return Object.entries(map).map(([name,value]) => ({name,value})).sort((a,b) => b.value-a.value).slice(0,8);
      }, [filtered]);

      const sortedTx = useMemo(() => [...filtered].sort((a,b) => b.date.localeCompare(a.date)), [filtered]);
      const txPerPage = 15;
      const txPages = Math.ceil(sortedTx.length / txPerPage);
      const pageTx = sortedTx.slice(txPage * txPerPage, (txPage+1) * txPerPage);

      if (!supabaseConfigured) {
        return (
          <div style={{minHeight:"100vh",background:"linear-gradient(145deg, #0d0d1a 0%, #1a1a2e 50%, #16213e 100%)",display:"flex",alignItems:"center",justifyContent:"center",padding:32}}>
            <div style={{background:"rgba(255,255,255,0.04)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:16,padding:"40px 32px",maxWidth:520,textAlign:"center",color:"#e0e0e0"}}>
              <div style={{fontSize:48,marginBottom:16}}>âš™ï¸</div>
              <h2 style={{color:"#fff",fontSize:20,marginBottom:12}}>Supabase Not Configured</h2>
              <p style={{color:"#999",lineHeight:1.7,fontSize:14,marginBottom:20}}>
                Open <code style={{background:"rgba(255,255,255,0.1)",padding:"2px 8px",borderRadius:4,color:"#7dd3fc"}}>index.html</code> and set your Supabase credentials.
              </p>
              <div style={{background:"rgba(37,99,235,0.1)",border:"1px solid rgba(37,99,235,0.3)",borderRadius:10,padding:16,textAlign:"left",fontSize:13,color:"#93c5fd",lineHeight:1.8}}>
                <div><strong>1.</strong> Supabase Dashboard â†’ Settings â†’ API</div>
                <div><strong>2.</strong> Copy <strong>Project URL</strong> + <strong>anon key</strong></div>
                <div><strong>3.</strong> Paste in config at top of <code>index.html</code></div>
                <div><strong>4.</strong> Run the SQL migration files</div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div style={{minHeight:"100vh",background:"linear-gradient(145deg, #0d0d1a 0%, #1a1a2e 50%, #16213e 100%)",color:"#e0e0e0",fontFamily:"'Noto Sans JP', system-ui, sans-serif"}}>
          {/* Header */}
          <div style={{background:"rgba(255,255,255,0.03)",borderBottom:"1px solid rgba(255,255,255,0.06)",padding:"20px 24px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:12}}>
            <div>
              <div style={{fontSize:11,letterSpacing:3,textTransform:"uppercase",color:"#666",marginBottom:4}}>å®¶è¨ˆç°¿</div>
              <h1 style={{fontSize:22,fontWeight:700,color:"#fff",letterSpacing:-0.5,margin:0}}>Cost Management</h1>
            </div>
            <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
              {["add","overview","transactions"].map(v => (
                <button key={v} onClick={() => { setView(v); setTxPage(0); }} style={pillStyle(view===v)}>
                  {v === "add" ? "â• Add Entry" : v === "overview" ? "ğŸ“Š Overview" : "ğŸ“‹ Transactions"}
                </button>
              ))}
            </div>
          </div>

          {/* Filters (only for overview/transactions) */}
          {view !== "add" && (
            <div style={{padding:"16px 24px",display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"}}>
              <span style={{fontSize:12,color:"#666",marginRight:4}}>Filter:</span>
              <select value={yearFilter} onChange={e => setYearFilter(e.target.value)} style={{background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.1)",color:"#ddd",padding:"6px 12px",borderRadius:8,fontSize:13}}>
                <option value="All">All Years</option>
                {years.map(y => <option key={y} value={y}>{y}</option>)}
              </select>
              <select value={catFilter} onChange={e => setCatFilter(e.target.value)} style={{background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.1)",color:"#ddd",padding:"6px 12px",borderRadius:8,fontSize:13}}>
                <option value="All">All Categories</option>
                {categories.map(c => <option key={c} value={c}>{CAT_ICONS[c]||"ğŸ“¦"} {c}</option>)}
              </select>
            </div>
          )}

          <div style={{padding:"0 24px 32px"}}>
            {loading ? (
              <div style={{textAlign:"center",padding:80,color:"#888"}}>
                <div style={{fontSize:32,marginBottom:12}}>â³</div>
                <div>Loadingâ€¦</div>
              </div>
            ) : view === "add" ? (
              <AddEntryView supabase={supabase} shops={shops} onAdded={fetchData} />
            ) : view === "overview" ? (
              <OverviewView {...{filtered,totalSpend,monthlyAvg,dailyAvg,txCount,monthlyData,catData,topShops}} />
            ) : (
              <TransactionsView {...{pageTx,txPage,setTxPage,txPages}} />
            )}
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MULTI-DATE CALENDAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function MultiDateCalendar({ selectedDates, setSelectedDates }) {
      const [viewDate, setViewDate] = useState(() => {
        const d = selectedDates[0] ? new Date(selectedDates[0]) : new Date();
        return { year: d.getFullYear(), month: d.getMonth() };
      });

      const daysInMonth = new Date(viewDate.year, viewDate.month + 1, 0).getDate();
      const firstDayOfWeek = new Date(viewDate.year, viewDate.month, 1).getDay();

      const prevMonth = () => setViewDate(v => v.month === 0 ? { year: v.year - 1, month: 11 } : { ...v, month: v.month - 1 });
      const nextMonth = () => setViewDate(v => v.month === 11 ? { year: v.year + 1, month: 0 } : { ...v, month: v.month + 1 });

      const toggleDate = (day) => {
        const dateStr = `${viewDate.year}-${String(viewDate.month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        setSelectedDates(prev => prev.includes(dateStr) ? prev.filter(d => d !== dateStr) : [...prev, dateStr]);
      };

      const isSelected = (day) => {
        const dateStr = `${viewDate.year}-${String(viewDate.month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        return selectedDates.includes(dateStr);
      };

      const isToday = (day) => {
        const today = new Date();
        return viewDate.year === today.getFullYear() && viewDate.month === today.getMonth() && day === today.getDate();
      };

      return (
        <div style={{background:"rgba(255,255,255,0.03)",borderRadius:12,padding:16,border:"1px solid rgba(255,255,255,0.06)"}}>
          {/* Header with navigation */}
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
            <button onClick={prevMonth} style={{background:"rgba(255,255,255,0.06)",border:"none",borderRadius:8,width:32,height:32,cursor:"pointer",color:"#aaa",fontSize:14}}>â—€</button>
            <div style={{fontSize:15,fontWeight:600,color:"#fff"}}>{MONTHS_FULL[viewDate.month]} {viewDate.year}</div>
            <button onClick={nextMonth} style={{background:"rgba(255,255,255,0.06)",border:"none",borderRadius:8,width:32,height:32,cursor:"pointer",color:"#aaa",fontSize:14}}>â–¶</button>
          </div>

          {/* Weekday headers */}
          <div style={{display:"grid",gridTemplateColumns:"repeat(7, 1fr)",gap:4,marginBottom:8}}>
            {["Su","Mo","Tu","We","Th","Fr","Sa"].map(d => (
              <div key={d} style={{textAlign:"center",fontSize:10,color:"#666",fontWeight:500,padding:4}}>{d}</div>
            ))}
          </div>

          {/* Days grid */}
          <div style={{display:"grid",gridTemplateColumns:"repeat(7, 1fr)",gap:4}}>
            {Array.from({ length: firstDayOfWeek }).map((_, i) => <div key={`e-${i}`} />)}
            {Array.from({ length: daysInMonth }).map((_, i) => {
              const day = i + 1;
              const selected = isSelected(day);
              const today = isToday(day);
              return (
                <button key={day} onClick={() => toggleDate(day)}
                  style={{
                    aspectRatio:"1",borderRadius:8,border:"none",cursor:"pointer",fontSize:13,fontWeight:selected?600:400,transition:"all 0.15s",
                    background: selected ? "rgba(37,99,235,0.8)" : today ? "rgba(255,255,255,0.08)" : "rgba(255,255,255,0.02)",
                    color: selected ? "#fff" : today ? "#7dd3fc" : "#aaa",
                    outline: today && !selected ? "1px solid rgba(125,211,252,0.3)" : "none",
                  }}>
                  {day}
                </button>
              );
            })}
          </div>

          {/* Quick actions */}
          <div style={{display:"flex",gap:8,marginTop:12,justifyContent:"center"}}>
            <button onClick={() => setSelectedDates([new Date().toISOString().slice(0,10)])}
              style={{background:"rgba(255,255,255,0.06)",border:"none",borderRadius:6,padding:"6px 12px",fontSize:11,color:"#aaa",cursor:"pointer"}}>Today</button>
            <button onClick={() => setSelectedDates([])}
              style={{background:"rgba(239,68,68,0.1)",border:"none",borderRadius:6,padding:"6px 12px",fontSize:11,color:"#ef4444",cursor:"pointer"}}>Clear All</button>
          </div>

          {/* Selected dates chips */}
          {selectedDates.length > 0 && (
            <div style={{marginTop:12,display:"flex",flexWrap:"wrap",gap:6}}>
              {selectedDates.sort().map(d => (
                <span key={d} style={{background:"rgba(37,99,235,0.2)",color:"#7dd3fc",padding:"4px 10px",borderRadius:8,fontSize:12,display:"flex",alignItems:"center",gap:6}}>
                  {d}
                  <button onClick={() => setSelectedDates(prev => prev.filter(x => x !== d))}
                    style={{background:"none",border:"none",color:"#7dd3fc",cursor:"pointer",fontSize:14,lineHeight:1,padding:0}}>Ã—</button>
                </span>
              ))}
            </div>
          )}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ADD ENTRY VIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function AddEntryView({ supabase, shops, onAdded }) {
      const [amount, setAmount] = useState("");
      const [selectedDates, setSelectedDates] = useState([new Date().toISOString().slice(0,10)]);
      const [category, setCategory] = useState("Supermarket");
      const [shop, setShop] = useState("");
      const [shopSearch, setShopSearch] = useState("");
      const [showShopDropdown, setShowShopDropdown] = useState(false);
      const [notes, setNotes] = useState("");
      const [saving, setSaving] = useState(false);
      const [toast, setToast] = useState(null);
      const [showAddShop, setShowAddShop] = useState(false);
      const [newShopName, setNewShopName] = useState("");
      const [newShopCategory, setNewShopCategory] = useState("Supermarket");
      const dropdownRef = useRef(null);

      // Filter shops by category and search
      const filteredShops = useMemo(() => {
        let list = [...shops];
        // First filter by category (unless searching)
        if (!shopSearch) {
          list = list.filter(s => s.category === category);
        } else {
          const q = shopSearch.toLowerCase();
          list = list.filter(s => s.name.toLowerCase().includes(q));
        }
        // Sort: favorites first, then alphabetical
        return list.sort((a,b) => {
          if (a.is_favorite && !b.is_favorite) return -1;
          if (!a.is_favorite && b.is_favorite) return 1;
          return a.name.localeCompare(b.name);
        });
      }, [shops, category, shopSearch]);

      const toggleFavorite = async (e, shopItem) => {
        e.stopPropagation();
        await supabase.from("cost_management_shops").update({ is_favorite: !shopItem.is_favorite }).eq("id", shopItem.id);
        onAdded();
      };

      const handleAddShop = async () => {
        if (!newShopName.trim()) return;
        const { error } = await supabase.from("cost_management_shops").insert({ name: newShopName.trim(), category: newShopCategory, is_favorite: false });
        if (!error) {
          setToast({ type: "success", msg: `Added "${newShopName}" to shops` });
          setNewShopName("");
          setShowAddShop(false);
          onAdded();
        } else {
          setToast({ type: "error", msg: error.message.includes("duplicate") ? "Shop already exists" : error.message });
        }
        setTimeout(() => setToast(null), 3000);
      };

      const selectShop = (name) => {
        setShop(name);
        setShopSearch(name);
        setShowShopDropdown(false);
      };

      const handleSubmit = async () => {
        if (!amount || Number(amount) <= 0) { setToast({type:"error",msg:"Enter a valid amount"}); setTimeout(() => setToast(null), 3000); return; }
        if (selectedDates.length === 0) { setToast({type:"error",msg:"Select at least one date"}); setTimeout(() => setToast(null), 3000); return; }
        const finalShop = shop || shopSearch.trim() || "Other";

        setSaving(true);
        const entries = selectedDates.map(date => ({
          amount: Number(amount), date, category, shop: finalShop, notes: notes.trim(),
        }));

        const { error } = await supabase.from("cost_management_expenses").insert(entries);
        setSaving(false);

        if (error) {
          setToast({type:"error",msg:"Failed: " + error.message});
        } else {
          setToast({type:"success",msg:`Saved Â¥${Number(amount).toLocaleString()} Ã— ${selectedDates.length} entry(s)`});
          setAmount(""); setNotes(""); setShop(""); setShopSearch(""); setSelectedDates([new Date().toISOString().slice(0,10)]);
          onAdded();
        }
        setTimeout(() => setToast(null), 3500);
      };

      const canPreview = amount && Number(amount) > 0 && selectedDates.length > 0;

      return (
        <div style={{maxWidth:600,margin:"0 auto"}}>
          {toast && (
            <div style={{position:"fixed",top:20,left:"50%",transform:"translateX(-50%)",zIndex:999,padding:"12px 24px",borderRadius:12,fontSize:14,fontWeight:500,background:toast.type==="success"?"rgba(16,185,129,0.95)":"rgba(239,68,68,0.95)",color:"#fff",boxShadow:"0 8px 32px rgba(0,0,0,0.4)",animation:"slideDown 0.3s ease"}}>
              {toast.type==="success"?"âœ…":"âŒ"} {toast.msg}
            </div>
          )}
          <style>{`@keyframes slideDown { from { opacity:0; transform:translateX(-50%) translateY(-20px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }`}</style>

          <div style={{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:16,padding:"28px 24px",marginTop:8}}>
            <h3 style={{fontSize:16,fontWeight:600,color:"#fff",marginTop:0,marginBottom:24,display:"flex",alignItems:"center",gap:10}}>
              <span style={{background:"rgba(37,99,235,0.15)",width:36,height:36,borderRadius:10,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}}>ğŸ’°</span>
              New Expense
            </h3>

            {/* Amount */}
            <div style={{marginBottom:20}}>
              <label style={labelStyle}>Amount (Â¥)</label>
              <input type="number" inputMode="numeric" placeholder="0" value={amount} onChange={e => setAmount(e.target.value)}
                style={{...inputStyle,fontSize:24,fontWeight:700,letterSpacing:-0.5,textAlign:"center"}}
                onFocus={e => e.target.style.borderColor="rgba(37,99,235,0.5)"}
                onBlur={e => e.target.style.borderColor="rgba(255,255,255,0.12)"}/>
            </div>

            {/* Multi-Date Calendar */}
            <div style={{marginBottom:20}}>
              <label style={labelStyle}>Date(s) â€” click to select multiple</label>
              <MultiDateCalendar selectedDates={selectedDates} setSelectedDates={setSelectedDates} />
            </div>

            {/* Category */}
            <div style={{marginBottom:20}}>
              <label style={labelStyle}>Category</label>
              <div style={{display:"flex",flexWrap:"wrap",gap:8}}>
                {CATEGORIES.map(cat => (
                  <button key={cat} onClick={() => { setCategory(cat); setShop(""); setShopSearch(""); }}
                    style={{
                      padding:"8px 14px",borderRadius:10,border:"none",cursor:"pointer",fontSize:13,fontWeight:500,transition:"all 0.2s",
                      background: category===cat ? `${CAT_COLORS[cat]}30` : "rgba(255,255,255,0.04)",
                      color: category===cat ? CAT_COLORS[cat] : "#888",
                      outline: category===cat ? `2px solid ${CAT_COLORS[cat]}50` : "2px solid transparent",
                    }}>
                    {CAT_ICONS[cat]} {cat}
                  </button>
                ))}
              </div>
            </div>

            {/* Shop â€” autocomplete with favorites */}
            <div style={{marginBottom:20,position:"relative"}} ref={dropdownRef}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                <label style={{...labelStyle,marginBottom:0}}>Shop</label>
                <button onClick={() => setShowAddShop(true)} style={{background:"rgba(16,185,129,0.15)",border:"none",borderRadius:6,padding:"4px 10px",fontSize:11,color:"#10b981",cursor:"pointer",fontWeight:500}}>
                  + Add New Shop
                </button>
              </div>
              <input
                type="text"
                placeholder="Search or type shop nameâ€¦"
                value={shopSearch}
                onChange={e => { setShopSearch(e.target.value); setShop(""); setShowShopDropdown(true); }}
                onFocus={() => setShowShopDropdown(true)}
                style={inputStyle}
              />
              {showShopDropdown && (
                <>
                  <div style={{position:"fixed",inset:0,zIndex:40}} onClick={() => setShowShopDropdown(false)}/>
                  <div style={{position:"absolute",top:"100%",left:0,right:0,zIndex:50,background:"#1a1a2e",border:"1px solid rgba(255,255,255,0.1)",borderRadius:10,marginTop:4,maxHeight:280,overflowY:"auto",boxShadow:"0 8px 32px rgba(0,0,0,0.5)"}}>
                    {filteredShops.length > 0 && filteredShops.map(s => (
                      <div key={s.id} onClick={() => selectShop(s.name)}
                        style={{display:"flex",alignItems:"center",padding:"10px 14px",cursor:"pointer",borderBottom:"1px solid rgba(255,255,255,0.05)",transition:"background 0.15s"}}
                        onMouseEnter={e => e.currentTarget.style.background="rgba(255,255,255,0.05)"}
                        onMouseLeave={e => e.currentTarget.style.background="transparent"}>
                        <button onClick={(e) => toggleFavorite(e, s)}
                          style={{background:"none",border:"none",cursor:"pointer",fontSize:16,marginRight:10,opacity:s.is_favorite?1:0.3,transition:"opacity 0.2s"}}>â­</button>
                        <div style={{flex:1}}>
                          <div style={{color:"#eee",fontSize:14}}>{s.name}</div>
                          <div style={{color:"#666",fontSize:11}}>{s.category}</div>
                        </div>
                      </div>
                    ))}
                    
                    {/* Always show "Other" option */}
                    <div onClick={() => selectShop("Other")}
                      style={{display:"flex",alignItems:"center",padding:"10px 14px",cursor:"pointer",background:"rgba(139,92,246,0.08)",borderTop:"1px solid rgba(255,255,255,0.08)"}}
                      onMouseEnter={e => e.currentTarget.style.background="rgba(139,92,246,0.15)"}
                      onMouseLeave={e => e.currentTarget.style.background="rgba(139,92,246,0.08)"}>
                      <span style={{marginRight:10}}>ğŸ“¦</span>
                      <div style={{color:"#c4b5fd",fontSize:14}}>Other</div>
                    </div>

                    {/* Option to use typed value if not found */}
                    {shopSearch && !filteredShops.find(s => s.name.toLowerCase() === shopSearch.toLowerCase()) && shopSearch.toLowerCase() !== "other" && (
                      <div onClick={() => selectShop(shopSearch)}
                        style={{padding:"10px 14px",background:"rgba(37,99,235,0.08)",borderTop:"1px solid rgba(255,255,255,0.08)",cursor:"pointer"}}
                        onMouseEnter={e => e.currentTarget.style.background="rgba(37,99,235,0.15)"}
                        onMouseLeave={e => e.currentTarget.style.background="rgba(37,99,235,0.08)"}>
                        <span style={{color:"#7dd3fc",fontSize:13}}>Use "<strong>{shopSearch}</strong>" as shop name</span>
                      </div>
                    )}
                  </div>
                </>
              )}
            </div>

            {/* Notes */}
            <div style={{marginBottom:24}}>
              <label style={labelStyle}>Notes (optional)</label>
              <input type="text" placeholder="ramen, haircut, etc." value={notes} onChange={e => setNotes(e.target.value)}
                style={inputStyle}
                onFocus={e => e.target.style.borderColor="rgba(37,99,235,0.5)"}
                onBlur={e => e.target.style.borderColor="rgba(255,255,255,0.12)"}/>
            </div>

            {/* Preview */}
            {canPreview && (
              <div style={{background:"rgba(255,255,255,0.03)",borderRadius:10,padding:"12px 16px",marginBottom:16}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:selectedDates.length > 1 ? 8 : 0}}>
                  <div style={{fontSize:13,color:"#aaa"}}>
                    {CAT_ICONS[category]} {shop || shopSearch || "Other"}
                    {notes && <span style={{color:"#666"}}> Â· {notes}</span>}
                  </div>
                  <div style={{fontSize:20,fontWeight:700,color:"#fff"}}>{fmt(Number(amount))}</div>
                </div>
                {selectedDates.length > 1 && (
                  <>
                    <div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:8}}>
                      {selectedDates.sort().slice(0,5).map(d => (
                        <span key={d} style={{background:"rgba(37,99,235,0.2)",color:"#7dd3fc",padding:"2px 8px",borderRadius:6,fontSize:11}}>{d}</span>
                      ))}
                      {selectedDates.length > 5 && <span style={{color:"#888",fontSize:11}}>+{selectedDates.length - 5} more</span>}
                    </div>
                    <div style={{fontSize:12,color:"#10b981",fontWeight:500}}>
                      Total: {fmt(Number(amount) * selectedDates.length)} ({selectedDates.length} entries)
                    </div>
                  </>
                )}
              </div>
            )}

            {/* Submit */}
            <button onClick={handleSubmit} disabled={saving}
              style={{
                width:"100%",padding:"14px",borderRadius:12,border:"none",cursor:saving?"wait":"pointer",
                fontSize:15,fontWeight:600,color:"#fff",
                background:saving?"rgba(37,99,235,0.4)":"linear-gradient(135deg,#2563eb,#7c3aed)",
                transition:"all 0.2s",opacity:saving?0.7:1,
              }}>
              {saving ? "Savingâ€¦" : `ğŸ’¾ Save ${selectedDates.length > 1 ? `${selectedDates.length} Entries` : "Expense"}`}
            </button>
          </div>

          {/* Add Shop Modal */}
          {showAddShop && (
            <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100,padding:20}}>
              <div style={{background:"#1a1a2e",border:"1px solid rgba(255,255,255,0.1)",borderRadius:16,padding:24,width:"100%",maxWidth:400}}>
                <h4 style={{color:"#fff",fontSize:16,marginTop:0,marginBottom:20,display:"flex",alignItems:"center",gap:8}}>
                  <span style={{fontSize:20}}>ğŸª</span> Add New Shop
                </h4>
                <div style={{marginBottom:16}}>
                  <label style={labelStyle}>Shop Name</label>
                  <input type="text" placeholder="e.g., Life Supermarket" value={newShopName} onChange={e => setNewShopName(e.target.value)}
                    style={inputStyle} autoFocus/>
                </div>
                <div style={{marginBottom:20}}>
                  <label style={labelStyle}>Default Category</label>
                  <select value={newShopCategory} onChange={e => setNewShopCategory(e.target.value)}
                    style={{...inputStyle,cursor:"pointer"}}>
                    {CATEGORIES.map(c => <option key={c} value={c}>{CAT_ICONS[c]} {c}</option>)}
                  </select>
                </div>
                <div style={{display:"flex",gap:10}}>
                  <button onClick={() => setShowAddShop(false)}
                    style={{flex:1,padding:"12px",borderRadius:10,border:"1px solid rgba(255,255,255,0.1)",background:"transparent",color:"#aaa",cursor:"pointer",fontSize:14}}>Cancel</button>
                  <button onClick={handleAddShop}
                    style={{flex:1,padding:"12px",borderRadius:10,border:"none",background:"#10b981",color:"#fff",cursor:"pointer",fontSize:14,fontWeight:600}}>Add Shop</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  OVERVIEW VIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function OverviewView({ filtered, totalSpend, monthlyAvg, dailyAvg, txCount, monthlyData, catData, topShops }) {
      return (
        <>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))",gap:12,marginBottom:24}}>
            {[
              {label:"Total Spent",value:fmt(totalSpend),accent:"#2563eb"},
              {label:"Monthly Avg",value:fmt(monthlyAvg),accent:"#10b981"},
              {label:"Daily Avg",value:fmt(dailyAvg),accent:"#f59e0b"},
              {label:"Transactions",value:txCount.toLocaleString(),accent:"#ec4899"},
            ].map((card,i) => (
              <div key={i} style={{background:"rgba(255,255,255,0.04)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:12,padding:"18px 16px",borderLeft:`3px solid ${card.accent}`}}>
                <div style={{fontSize:11,color:"#777",textTransform:"uppercase",letterSpacing:1,marginBottom:6}}>{card.label}</div>
                <div style={{fontSize:20,fontWeight:700,color:"#fff"}}>{card.value}</div>
              </div>
            ))}
          </div>

          <div style={{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:14,padding:"20px 16px",marginBottom:20}}>
            <h3 style={{fontSize:14,fontWeight:600,color:"#ccc",marginBottom:16,paddingLeft:8,marginTop:0}}>Monthly Spending Trend</h3>
            <ResponsiveContainer width="100%" height={260}>
              <AreaChart data={monthlyData}>
                <defs><linearGradient id="grad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#2563eb" stopOpacity={0.3}/><stop offset="100%" stopColor="#2563eb" stopOpacity={0.02}/></linearGradient></defs>
                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.04)"/>
                <XAxis dataKey="label" tick={{fontSize:11,fill:"#666"}} axisLine={false} tickLine={false}/>
                <YAxis tick={{fontSize:11,fill:"#666"}} axisLine={false} tickLine={false} tickFormatter={v => `Â¥${(v/1000).toFixed(0)}k`}/>
                <Tooltip content={<CustomTooltip/>}/>
                <Area type="monotone" dataKey="total" name="Spending" stroke="#2563eb" fill="url(#grad)" strokeWidth={2}/>
              </AreaChart>
            </ResponsiveContainer>
          </div>

          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(280px, 1fr))",gap:16}}>
            <div style={{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:14,padding:"20px 16px"}}>
              <h3 style={{fontSize:14,fontWeight:600,color:"#ccc",marginBottom:12,paddingLeft:8,marginTop:0}}>Category Breakdown</h3>
              <ResponsiveContainer width="100%" height={200}>
                <PieChart><Pie data={catData} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={50} outerRadius={80} paddingAngle={2}>
                  {catData.map((entry,i) => <Cell key={i} fill={CAT_COLORS[entry.name]||"#666"} stroke="none"/>)}
                </Pie><Tooltip content={<CustomTooltip/>}/></PieChart>
              </ResponsiveContainer>
              <div style={{display:"flex",flexWrap:"wrap",gap:8,justifyContent:"center",marginTop:8}}>
                {catData.map((c,i) => (
                  <div key={i} style={{display:"flex",alignItems:"center",gap:5,fontSize:11,color:"#aaa"}}>
                    <div style={{width:8,height:8,borderRadius:2,background:CAT_COLORS[c.name]||"#666"}}/>{CAT_ICONS[c.name]||""} {c.name}
                  </div>
                ))}
              </div>
            </div>
            <div style={{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:14,padding:"20px 16px"}}>
              <h3 style={{fontSize:14,fontWeight:600,color:"#ccc",marginBottom:12,paddingLeft:8,marginTop:0}}>Top Shops</h3>
              <div style={{display:"flex",flexDirection:"column",gap:8}}>
                {topShops.map((shop,i) => {
                  const pct = topShops[0]?.value ? (shop.value / topShops[0].value)*100 : 0;
                  return (
                    <div key={i} style={{display:"flex",alignItems:"center",gap:10}}>
                      <div style={{fontSize:11,color:"#888",width:18,textAlign:"right"}}>{i+1}</div>
                      <div style={{flex:1,minWidth:0}}>
                        <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                          <span style={{fontSize:12,color:"#ccc",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{shop.name}</span>
                          <span style={{fontSize:12,color:"#fff",fontWeight:600,flexShrink:0,marginLeft:8}}>{fmt(shop.value)}</span>
                        </div>
                        <div style={{height:4,background:"rgba(255,255,255,0.05)",borderRadius:2,overflow:"hidden"}}>
                          <div style={{height:"100%",width:`${pct}%`,background:"linear-gradient(90deg,#2563eb,#7c3aed)",borderRadius:2,transition:"width 0.5s"}}/>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          <div style={{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:14,padding:"20px 16px",marginTop:16}}>
            <h3 style={{fontSize:14,fontWeight:600,color:"#ccc",marginBottom:16,paddingLeft:8,marginTop:0}}>Monthly Comparison</h3>
            <ResponsiveContainer width="100%" height={220}>
              <BarChart data={monthlyData}>
                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.04)"/>
                <XAxis dataKey="label" tick={{fontSize:10,fill:"#666"}} axisLine={false} tickLine={false}/>
                <YAxis tick={{fontSize:10,fill:"#666"}} axisLine={false} tickLine={false} tickFormatter={v => `Â¥${(v/1000).toFixed(0)}k`}/>
                <Tooltip content={<CustomTooltip/>}/>
                <Bar dataKey="total" name="Spending" fill="#2563eb" radius={[4,4,0,0]} maxBarSize={32}/>
              </BarChart>
            </ResponsiveContainer>
          </div>
        </>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  TRANSACTIONS VIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function TransactionsView({ pageTx, txPage, setTxPage, txPages }) {
      return (
        <div style={{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:14,overflow:"hidden"}}>
          <div style={{overflowX:"auto"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
              <thead>
                <tr style={{borderBottom:"1px solid rgba(255,255,255,0.08)"}}>
                  {["Date","Shop","Category","Amount","Notes"].map(h => (
                    <th key={h} style={{padding:"14px 12px",textAlign:"left",color:"#888",fontWeight:500,fontSize:11,textTransform:"uppercase",letterSpacing:1}}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {pageTx.map((tx,i) => (
                  <tr key={tx.id || i} style={{borderBottom:"1px solid rgba(255,255,255,0.04)",transition:"background 0.15s"}}
                    onMouseEnter={e => e.currentTarget.style.background="rgba(255,255,255,0.03)"}
                    onMouseLeave={e => e.currentTarget.style.background="transparent"}>
                    <td style={{padding:"10px 12px",color:"#aaa",whiteSpace:"nowrap"}}>{tx.date}</td>
                    <td style={{padding:"10px 12px",color:"#ddd",fontWeight:500}}>{tx.shop}</td>
                    <td style={{padding:"10px 12px"}}>
                      <span style={{display:"inline-block",padding:"3px 10px",borderRadius:12,fontSize:11,fontWeight:500,background:`${CAT_COLORS[tx.category]||"#666"}20`,color:CAT_COLORS[tx.category]||"#666"}}>
                        {CAT_ICONS[tx.category]||""} {tx.category}
                      </span>
                    </td>
                    <td style={{padding:"10px 12px",color:"#fff",fontWeight:600,fontVariantNumeric:"tabular-nums"}}>{fmt(tx.amount)}</td>
                    <td style={{padding:"10px 12px",color:"#777",fontSize:12,maxWidth:180,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{tx.notes || "â€”"}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div style={{display:"flex",justifyContent:"center",alignItems:"center",gap:8,padding:"16px"}}>
            <button onClick={() => setTxPage(p => Math.max(0,p-1))} disabled={txPage===0}
              style={{padding:"6px 14px",borderRadius:8,border:"none",cursor:txPage===0?"default":"pointer",background:txPage===0?"rgba(255,255,255,0.02)":"rgba(255,255,255,0.08)",color:txPage===0?"#444":"#ccc",fontSize:12}}>â† Prev</button>
            <span style={{fontSize:12,color:"#777"}}>{txPage+1} / {txPages || 1}</span>
            <button onClick={() => setTxPage(p => Math.min(txPages-1,p+1))} disabled={txPage>=txPages-1}
              style={{padding:"6px 14px",borderRadius:8,border:"none",cursor:txPage>=txPages-1?"default":"pointer",background:txPage>=txPages-1?"rgba(255,255,255,0.02)":"rgba(255,255,255,0.08)",color:txPage>=txPages-1?"#444":"#ccc",fontSize:12}}>Next â†’</button>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
